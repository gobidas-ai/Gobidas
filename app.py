import streamlit as st
import os, json, base64, time
from groq import Groq
from datetime import datetime

# --- 1. CONFIG ---
st.set_page_config(page_title="Gobidas AI", layout="wide")
MODEL_NAME = "llama-3.1-8b-instant"

try:
    client = Groq(api_key=st.secrets["GROQ_API_KEY"])
except:
    st.error("API Key missing in Secrets!")

# File paths for persistence
USER_DB = "users_db.json"
CHAT_DB = "chat_histories.json"

def load_data(file, default):
    if os.path.exists(file):
        with open(file, "r") as f: return json.load(f)
    return default

def save_data(file, data):
    with open(file, "w") as f: json.dump(data, f)

# --- 2. THEME & UI ---
def get_base64(file):
    try:
        with open(file, 'rb') as f: return base64.b64encode(f.read()).decode()
    except: return ""

bin_str = get_base64('background.jpg')
st.markdown(f"""
<style>
    [data-testid="stHeader"] {{ background: transparent !important; }}
    .stApp {{ 
        background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url("data:image/jpeg;base64,{bin_str}"); 
        background-size: cover; 
    }}
    .main-title {{ font-weight: 900; color: #FF6D00; text-align: center; font-size: 5rem; text-shadow: 0px 0px 25px #FF6D00; }}
    .stButton>button {{ width: 100%; border: 2px solid #FF6D00 !important; color: white !important; background: rgba(0,0,0,0.2) !important; font-weight: bold; border-radius: 8px; }}
    [data-testid="stSidebar"] {{ background-color: #000000 !important; border-right: 1px solid #FF6D00; }}
    .legal-scroll {{ font-size: 0.85rem; color: #ccc; background: rgba(255,109,0,0.1); padding: 15px; border-radius: 10px; border: 1px solid #FF6D00; height: 250px; overflow-y: scroll; }}
</style>
""", unsafe_allow_html=True)

# --- 3. LOGIN / SIGNUP ---
if "user" not in st.session_state:
    st.markdown("<h1 class='main-title'>Gobidas</h1>", unsafe_allow_html=True)
    t1, t2 = st.tabs(["LOG IN", "CREATE ACCOUNT"])
    
    with t1:
        u_l = st.text_input("Username", key="l_u")
        p_l = st.text_input("Password", type="password", key="l_p")
        if st.button("LOG IN"):
            users = load_data(USER_DB, {"admin": "gobidas2025"})
            if u_l in users and users[u_l] == p_l:
                st.session_state.user = u_l
                st.rerun()
            else: st.error("Invalid credentials.")

    with t2:
        u_s = st.text_input("New Username", key="s_u")
        p_s = st.text_input("New Password", type="password", key="s_p")
        st.markdown("### Official Terms of Service")
        st.markdown("<div class='legal-scroll'><b>1. Acceptance:</b> Use of Gobidas AI implies agreement to all terms. <br><b>2. Privacy:</b> Your data is stored for session context only. <br><b>3. AI:</b> Responses are generated by Llama 3.1. Accuracy is not guaranteed.</div>", unsafe_allow_html=True)
        if st.button("REGISTER"):
            if len(u_s) > 2 and len(p_s) > 5:
                users = load_data(USER_DB, {"admin": "gobidas2025"})
                users[u_s] = p_s
                save_data(USER_DB, users)
                st.success("Account created! Log in.")
            else: st.error("Username (3+) and Password (6+) required.")
    st.stop()

# --- 4. PERSISTENT HISTORY & SESSION LOGIC ---
if "messages" not in st.session_state:
    # Load history from file if it exists
    all_histories = load_data(CHAT_DB, {})
    st.session_state.messages = all_histories.get(st.session_state.user, [{"role": "system", "content": "You are Gobidas AI."}])

# --- 5. SIDEBAR (SETTINGS & NEW CHAT) ---
with st.sidebar:
    st.title(f"@{st.session_state.user}")
    
    if st.button("‚ûï NEW CHAT"):
        st.session_state.messages = [{"role": "system", "content": "You are Gobidas AI."}]
        all_h = load_data(CHAT_DB, {})
        all_h[st.session_state.user] = st.session_state.messages
        save_data(CHAT_DB, all_h)
        st.rerun()

    with st.expander("‚öôÔ∏è SETTINGS"):
        st.write("Model: Llama 3.1 8B")
        st.write("Status: Live")
        if st.button("Clear Saved Database"):
            save_data(CHAT_DB, {})
            st.rerun()

    st.divider()
    st.subheader("Image Attachment")
    # File uploader in sidebar, but logic sends to chat
    uploaded_file = st.file_uploader("Upload Image", type=['png', 'jpg', 'jpeg'], key="img_up")
    
    st.divider()
    if st.button("üö™ LOGOUT"):
        del st.session_state.user
        st.rerun()

# --- 6. MAIN CHAT AREA ---
st.markdown("<h1 class='main-title'>Gobidas AI</h1>", unsafe_allow_html=True)

# Display existing messages
for m in st.session_state.messages:
    if m["role"] != "system":
        with st.chat_message(m["role"]):
            if "content" in m: st.markdown(m["content"])
            if "image" in m: st.image(m["image"])

# Prompt Handling
if prompt := st.chat_input("Ask me anything..."):
    new_message = {"role": "user", "content": prompt}
    
    # If an image was uploaded, attach it to THIS specific user message
    if uploaded_file:
        img_data = uploaded_file.getvalue()
        new_message["image"] = img_data
        # Clear the uploader by resetting the key state (requires rerun or specific logic)
    
    st.session_state.messages.append(new_message)
    
    with st.chat_message("user"):
        st.markdown(prompt)
        if "image" in new_message: st.image(new_message["image"])

    with st.chat_message("assistant"):
        try:
            # Send only text content to Groq
            chat_context = [{"role": m["role"], "content": m["content"]} for m in st.session_state.messages]
            resp = client.chat.completions.create(model=MODEL_NAME, messages=chat_context)
            ans = resp.choices[0].message.content
            st.markdown(ans)
            st.session_state.messages.append({"role": "assistant", "content": ans})
            
            # Save to Database immediately
            all_h = load_data(CHAT_DB, {})
            all_h[st.session_state.user] = st.session_state.messages
            save_data(CHAT_DB, all_h)
        except Exception as e:
            st.error(f"AI Error: {e}")
